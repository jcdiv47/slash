# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Slash is an open source, self-hosted link shortening platform written in Go with a React frontend. It allows users to create customizable `s/` short links, organize them with tags and collections, and share them with teams or publicly.

## Architecture

### Backend (Go)

**Tech Stack:**
- Echo v4 web framework
- gRPC with grpc-gateway for REST/gRPC dual API
- Protocol Buffers for API contracts
- SQLite (default) or PostgreSQL for data storage
- JWT authentication

**Key Components:**

1. **Server** (`server/`): Main HTTP/gRPC server
   - Runs on port 8082 by default (HTTP), gRPC on port+1 (8083)
   - `server/server.go`: Server initialization and lifecycle
   - Uses Echo for HTTP routing and grpc-gateway for REST API
   - Dual protocol: gRPC-Web for frontend, REST API via grpc-gateway

2. **API Services** (`server/route/api/v1/`):
   - All services implement gRPC servers with auto-generated REST endpoints
   - Services: Auth, User, UserSetting, Shortcut, Collection, Workspace, Subscription
   - `v1.go`: APIV1Service registers all gRPC services and gateway
   - `acl.go`: Access control logic for resources
   - Authentication via JWT interceptor (`auth.go`)

3. **Store Layer** (`store/`):
   - `store.go`: Store struct with sync.Map caches for users, shortcuts, settings
   - `driver.go`: Database driver abstraction
   - `db/sqlite/` and `db/postgres/`: Database-specific implementations
   - `migrator.go`: Database migration logic
   - Each entity (shortcut, collection, user, etc.) has dedicated files with CRUD operations

4. **Proto Definitions** (`proto/`):
   - `api/v1/*.proto`: Service definitions and API contracts
   - `store/*.proto`: Data models for storage layer
   - Generate code with `buf generate` in the `proto/` directory

5. **License Service** (`server/service/license/`):
   - LemonSqueezy integration for subscription management
   - Feature matrix controls (shortcuts limit, analytics, custom domains, etc.)

### Frontend (React + TypeScript)

**Location:** `frontend/web/`

**Tech Stack:**
- React 18 with TypeScript
- Vite for build tooling
- MUI Joy UI components
- Zustand for state management
- nice-grpc-web for gRPC communication
- React Router v7
- Tailwind CSS

**Structure:**
- `src/components/`: Reusable React components
- `src/pages/`: Page-level components
- `src/stores/`: Zustand state stores
- `src/types/proto/`: Auto-generated TypeScript types from protobuf (generated by buf)
- `grpcweb.ts`: gRPC-Web client setup

### Browser Extension

**Location:** `frontend/extension/`

Chrome/Firefox extension for quick access to shortcuts in the browser's search bar.

## Development Commands

### Backend

**Build the server:**
```bash
./scripts/build.sh
# Output: ./build/slash
```

**Run in development mode:**
```bash
go run ./bin/slash/main.go --mode dev --port 8082
# Or using the built binary:
./build/slash --mode dev
```

**Run in production mode:**
```bash
./build/slash --mode prod --port 8082 --data /path/to/data
```

**Run tests:**
```bash
go test ./...
```

**Run a specific test:**
```bash
go test -v ./path/to/package -run TestName
```

**Lint:**
```bash
golangci-lint run
```

**Database drivers:**
- SQLite (default): No additional setup required
- PostgreSQL: Use `--driver postgres --dsn "postgres://..."` flags

### Frontend (Web)

**Directory:** `frontend/web/`

**Development server:**
```bash
cd frontend/web
npm run dev
```

**Build for production:**
```bash
cd frontend/web
npm run build
```

**Lint:**
```bash
cd frontend/web
npm run lint
```

**Fix lint issues:**
```bash
cd frontend/web
npm run lint-fix
```

**Type check:**
```bash
cd frontend/web
npm run type-check
```

### Protocol Buffers

**Generate code from proto files:**
```bash
cd proto
buf generate
```

This generates:
- Go code in `proto/gen/`
- TypeScript types in `frontend/web/src/types/proto/`
- gRPC-Gateway REST mappings
- OpenAPI/Swagger specs

## Key Implementation Details

### Database Layer

The store layer uses a Driver interface with two implementations:
- `store/db/sqlite/`: SQLite implementation (default)
- `store/db/postgres/`: PostgreSQL implementation

The Driver is selected in `store/db/db.go:NewDBDriver()` based on profile settings.

Each driver implements the same interface defined in `store/driver.go`.

### Server Initialization Flow

1. `bin/slash/main.go`: CLI entry point using Cobra
2. Creates Profile with mode, port, data directory
3. Initializes database driver via `db.NewDBDriver()`
4. Creates Store instance and runs migrations
5. Creates Server with Echo and gRPC servers
6. Starts background runners (license, version check)
7. Starts gRPC server on port+1, HTTP server on configured port

### API Request Flow

1. HTTP request → Echo router → grpc-gateway
2. grpc-gateway → gRPC server (localhost)
3. gRPC interceptors: Logger → Authentication
4. Service handler in `server/route/api/v1/*_service.go`
5. ACL check via `GetCurrentUser()` and permission validation
6. Store layer operations
7. Response via protobuf

### Frontend-Backend Communication

Frontend uses nice-grpc-web to communicate directly with gRPC-Web endpoints:
- gRPC-Web: `POST /slash.api.v1.ServiceName/MethodName` (binary protobuf)
- REST fallback: `/api/v1/*` routes via grpc-gateway

### Authentication

- JWT tokens stored in session secrets
- Dev mode: constant secret "slash"
- Prod mode: random UUID stored in workspace settings
- Interceptor in `server/route/api/v1/auth.go` validates tokens
- User context passed through gRPC metadata

### License & Feature Gating

The `server/service/license/feature_matrix.go` defines feature limits:
- Free tier: Limited shortcuts, basic features
- Pro tier: Unlimited shortcuts, analytics, custom domains
- License validation via LemonSqueezy webhook

## Configuration

Server accepts these flags/env vars (prefix: `SLASH_`):
- `--mode` / `SLASH_MODE`: "dev" or "prod" (default: dev)
- `--port` / `SLASH_PORT`: HTTP port (default: 8082)
- `--data` / `SLASH_DATA`: Data directory for SQLite DB
- `--driver` / `SLASH_DRIVER`: "sqlite" or "postgres" (default: sqlite)
- `--dsn` / `SLASH_DSN`: Database connection string

## Docker Deployment

```bash
docker run -d --name slash -p 5231:5231 -v ~/.slash/:/var/opt/slash yourselfhosted/slash:latest
```

Note: Docker runs on port 5231, local dev typically uses 8082.

## Important Patterns

**Error Handling:**
- Use `github.com/pkg/errors.Wrap()` for error wrapping (enforced by linter)
- Never use `fmt.Errorf()` - forbidden by forbidigo linter

**Imports:**
- Local imports use `github.com/yourselfhosted/slash/` prefix
- golangci-lint enforces goimports with local prefix

**Resource Naming:**
- Follow pattern: `{resource}/{id}` (e.g., "shortcuts/123", "users/456")
- See `server/route/api/v1/resource_name.go` for helpers

**Caching:**
- Store layer maintains sync.Map caches for frequently accessed data
- Clear cache when updating entities
